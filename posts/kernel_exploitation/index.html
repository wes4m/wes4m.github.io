<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>إستغلال ثغرات النواة | Kernel exploitation | wes4m</title>
<meta name=keywords content="Kernel,Linux,PWN,Misc">
<meta name=description content="من اكثر الامثلة شيوعآ للإستخدام في هذا الموضوع هي مصطلحات مثل Android rooting, IOS Jailbreak ، فالكثير منا على إطلاع بها وبالغرض منها. ولكن هل تسائلت من قبل كيف تعمل في عمقها ؟
أيضآ لماذا لايمكنك إنهاء عمليات الـ Anti virus من مدير المهام في نظام وندوز بكل بساطة ؟ أو كيف تخفي بعض ملفات الإختراق نفسها عن برامج تتبع الإتصالات ومدير المهام وغيره.
كل هذه الإمور والكثير من الأمثلة الإخرى يمكن تنفيذها بعدة طرق أحدها ومن أهمها هي إستخدام نواة النظام وإستغلالها.">
<meta name=author content="wes4m">
<link rel=canonical href=https://wes4m.io/posts/kernel_exploitation/>
<link crossorigin=anonymous href=/assets/css/stylesheet.c266585e349dd9ce670351e0239f03ee0ebc4ca57cc47e0fd0d98f00e50aee7e.css integrity="sha256-wmZYXjSd2c5nA1HgI58D7g68TKV8xH4P0NmPAOUK7n4=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://wes4m.io/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://wes4m.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://wes4m.io/favicon-32x32.png>
<link rel=apple-touch-icon href=https://wes4m.io/apple-touch-icon.png>
<link rel=mask-icon href=https://wes4m.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<script src=/dist/webcomponents-loader.js></script>
<script src=/dist/gif-player.es6.js defer async></script>
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-X4Z7CWYY5B"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-X4Z7CWYY5B',{anonymize_ip:!1})}</script>
<meta property="og:title" content="إستغلال ثغرات النواة | Kernel exploitation">
<meta property="og:description" content="من اكثر الامثلة شيوعآ للإستخدام في هذا الموضوع هي مصطلحات مثل Android rooting, IOS Jailbreak ، فالكثير منا على إطلاع بها وبالغرض منها. ولكن هل تسائلت من قبل كيف تعمل في عمقها ؟
أيضآ لماذا لايمكنك إنهاء عمليات الـ Anti virus من مدير المهام في نظام وندوز بكل بساطة ؟ أو كيف تخفي بعض ملفات الإختراق نفسها عن برامج تتبع الإتصالات ومدير المهام وغيره.
كل هذه الإمور والكثير من الأمثلة الإخرى يمكن تنفيذها بعدة طرق أحدها ومن أهمها هي إستخدام نواة النظام وإستغلالها.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://wes4m.io/posts/kernel_exploitation/">
<meta property="og:image" content="https://wes4m.io/%3Cimage%20path/url%3E"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2019-08-13T04:51:01-07:00">
<meta property="article:modified_time" content="2019-08-13T04:51:01-07:00"><meta property="og:site_name" content="wes4m">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://wes4m.io/%3Cimage%20path/url%3E">
<meta name=twitter:title content="إستغلال ثغرات النواة | Kernel exploitation">
<meta name=twitter:description content="من اكثر الامثلة شيوعآ للإستخدام في هذا الموضوع هي مصطلحات مثل Android rooting, IOS Jailbreak ، فالكثير منا على إطلاع بها وبالغرض منها. ولكن هل تسائلت من قبل كيف تعمل في عمقها ؟
أيضآ لماذا لايمكنك إنهاء عمليات الـ Anti virus من مدير المهام في نظام وندوز بكل بساطة ؟ أو كيف تخفي بعض ملفات الإختراق نفسها عن برامج تتبع الإتصالات ومدير المهام وغيره.
كل هذه الإمور والكثير من الأمثلة الإخرى يمكن تنفيذها بعدة طرق أحدها ومن أهمها هي إستخدام نواة النظام وإستغلالها.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://wes4m.io/posts/"},{"@type":"ListItem","position":2,"name":"إستغلال ثغرات النواة | Kernel exploitation","item":"https://wes4m.io/posts/kernel_exploitation/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"إستغلال ثغرات النواة | Kernel exploitation","name":"إستغلال ثغرات النواة | Kernel exploitation","description":"من اكثر الامثلة شيوعآ للإستخدام في هذا الموضوع هي مصطلحات مثل Android rooting, IOS Jailbreak ، فالكثير منا على إطلاع بها وبالغرض منها. ولكن هل تسائلت من قبل كيف تعمل في عمقها ؟\nأيضآ لماذا لايمكنك إنهاء عمليات الـ Anti virus من مدير المهام في نظام وندوز بكل بساطة ؟ أو كيف تخفي بعض ملفات الإختراق نفسها عن برامج تتبع الإتصالات ومدير المهام وغيره.\nكل هذه الإمور والكثير من الأمثلة الإخرى يمكن تنفيذها بعدة طرق أحدها ومن أهمها هي إستخدام نواة النظام وإستغلالها.","keywords":["Kernel","Linux","PWN","Misc"],"articleBody":"من اكثر الامثلة شيوعآ للإستخدام في هذا الموضوع هي مصطلحات مثل Android rooting, IOS Jailbreak ، فالكثير منا على إطلاع بها وبالغرض منها. ولكن هل تسائلت من قبل كيف تعمل في عمقها ؟\nأيضآ لماذا لايمكنك إنهاء عمليات الـ Anti virus من مدير المهام في نظام وندوز بكل بساطة ؟ أو كيف تخفي بعض ملفات الإختراق نفسها عن برامج تتبع الإتصالات ومدير المهام وغيره.\nكل هذه الإمور والكثير من الأمثلة الإخرى يمكن تنفيذها بعدة طرق أحدها ومن أهمها هي إستخدام نواة النظام وإستغلالها.\nماهي النواة (Kernel) ؟ بشكل مبسط، تعمل أنظمة التشغيل مثل Windows, Linux, IOS وغيرها بنظام الطبقات والنواة هي أحد هذه الطبقات\nفماتراه كمستخدم عادي هو الـ Userspace أو الطبقة الاولى اللتي تحتوي على البرامج وسطح المكتب وغيره من واجهات، تليها النواة واللتي بدورها تتواصل مع عتاد الجهاز من ذاكرة، لوحة مفاتيح، المعالج وغيره .. فهي جزء حساس جدآ وغير قابل للأخطاء البرمجية. على سبيل المثال في الـ Userspace عندما يحدث خطأ في برنامج ما قد يتوقف البرنامج عن العمل أو يتمكن من تفادي الخطأ عن طريق الـ Exception handlers\nبينما الأخطاء في النواة قد تؤدي لعطب أجهزة وفي الغالب توقف النظام وإجبارك على إعادة تشغيله.\nالنواة مسؤولة عن التواصل مع العتاد والمدخلات والمخرجات للجهاز وإدارة نظام التشغيل بشكل مفصل جددآ فهي المسؤولة عن التواصل مع الذاكرة وحجز المساحات وعن تنظيم الصلاحيات وإدارة عمليات النظام وجدولتها، وأيضا حماية المستخدم وتوفير أمكانيات للعليات بالتواصل فيما بينها (IPC) وغيرها الكثير من مسؤوليات كبيرة تعق على النواة.\nتعمل أغلب أنوية الأنظمة على شكل Drivers \u0026 Modules على عكس الـ Userspace اللذي يعمل على شكل تطبيقات في الغالب.\nأين تقع النواة ؟ كما نعلم بأنه عند تشغيل أي برنامج يقوم النظام ( النواة ) بحجز مساحة في الذاكرة للبرنامج ومن ثم القيام بعلميات تجهيز الذاكرة وتحميل البرنامج فيها وجدولته وتشغيله. لكل برنامج مساحة في الذاكرة محددة قد تبدوا جميع موجوة في نفس العنوان من الذاكرة وذلك بسبب ( Virtual address space ) وهو موضوع واسع يمكنك القراءة فيه.\nبشكل مبسط هو عنوان وهمي أو إفتراضي يعطى لكل عملية ولكنه مربوط بعنوان آخر على حسب العملية (Physical address) في الذاكرة.\nفالنواة توجد في منطقة ثابته في الذاكرة ويتم إعطاء عنوان إفتراضي لها ايضا مع كل عملية.\nففي أنظمة الـ 64-bit سنرى أن لكل عملية عنواين إفتراضيه في الذاكرة من 0x000'00000000 - 0x7FF’FFFFFFFF\nبينما في 32-bit فالنطاق هو من 0x00000000 - 0x7FFFFFFF\nولكل عملية يتم تقسيم النطاق فيربط جزء منه للنواة لتصبح كل عملية قادرة على التواصل مع النواة.\nصورة مثال لذاكرة عملية في النظام:\nكيف تتواصل البرامج مع النواة ؟ تتعمد طريقة التواصل على نظام التشغيل وآليته. لنأخد على سبيل المثال Linux\nعندما يقوم مبرمج بعمل عملية وظيفتها طباعة نص للمستخدم فتسلسل الأحداث هو كالتالي\n يمكننا عمل كومبايل وتتبع العملية عن طريق ltrace \u0026 strace أو تتبع سورس كود فنكشن printf وسنرى أن المسار التالي هو المتبع\n ومايهمنا هنا هو النقطة الأخيرة SYSCALL فهذه هي الوسيلة الأساسية في التواصل مع النواة. وظيفتها تغيير مود المعالج الى kernel mode ونقل التنفيد للنواة فالـ SYSCALL هي تعليمة محددة INT 0x80 مع معلومات يتم وضعها في المسجلات والذاكرة\nتقوم بعمل Exception فيقوم المعالج بدوره بالعثور على عنوان الـ Exception handler وهو ثابت تحت مسمى Vector 128 أو System call handler ويشير إلى فنكشن بإسم system_call موجود بالنواة يقوم بتوجيه المعطيات على حسب رقم موجود في أحد المسجلات ( Registers ) فيوجهه للفنكشن المناسبة في حالتنا هذه sys_write الموجودة في النواة واللتي ستقوم بالعملية المطلوبة والتواصل مع الشاشة لطباعة النص.\nللمزيد من المعلومات\nلماذا لايمكننا إستدعاء عملية sys_write الموجودة في النواة مباشرة من الـ Userspace ؟ لانها ستعدم إنفصالية النواة عن الـ Userspace وستؤدي الى مشاكل امنية وعدم إستقرار في النظام فتواصل العمليات مباشرة مع النواة كما ناقشت سابقآ من السهل أن يؤدي لإغلاق النظام.\nثغرات النواة بالرغم من طول المقدمة السابقة إلا أنها مختصرة ولاتعطي للنواة نصيبها من الشرح فهي أكبر واهم جزء في أنظمة التشغيل.\nأما الآن فكيف يمكننا الوصول لذاكرة النواة، فالمعالج من وظيفته حماية ذاكرة النواة فلا يمكن للمبرمج بكل بساطة أن يحاول القراءة من عنوان ضمن نطاق ذاكرة النواة أو الكتابة إليه أو القفز لتنفيد كود فيه.\nإلا أنه هناك بعض الهجمات اللتي تستهدف المعالج وبعض الالكترونيات في الجهاز مثل Meltdown \u0026 Spectre\nولكنني سأتحدث حول ثغرات تنتج بسبب أخطاء برمجية سواء من مبرمجي Drivers \u0026 Modules النظام أو من شركات خارجية تقوم ببرمجة Drivers خاصة بهم للعمل مع النظام مثل كروت الشاشة وكروت الشبكة وغيرها من أجهزة أو برامج تحتاج لعمل Driver خاص.\nفالثغرات التي تحدث بالنواة هي نفسها التي يمكنك العثور عليها في الـ Usersapce مثل ثغرات الـ Bufferover flow, use-after-free, race conditions وغيرها من ثغرات مع إختلاف طرق الإستغلال، أغلب ثغرات النواة تكون معقدة وعبارة عن سلسلة من الثغرات مربوطة ببعضها (exploit chain) للوصول للهدف.\nكما طرحت في مقدمة الموضوع، على سبيل المثال أحد طرق عمل root لأجهزة Android هي ربط عدد من ثغرات النظام ببعضها بدئآ من الـ Userspace حتى الوصول للنواة (Kernel) ومن ثم التعديل على جدول الصلاحيات على سبيل المثال وإعطاء عملية محددة أعلى صلاحية في الجهاز root.\nفي هذا الموضوع سأتطرق لثغرة واحد فقط مع مثال لإستغلالها للحصول على رفع صلاحية (LPE - local privilege escalation)\nModule مبسط لنواة Linux شرح مفصل لطريقة برمجة Module للنواة\nقمت ببرمجة Module بسيط يحتوي على ثغرة يمكن إستغلالها لرفع الصلاحيات.\nبإستخدام الشرح السابق لتحميل مستلزمات الكومبايل. قم ببناء الـ Module التالي وتنصيبه في النواة\n عند تنصيبه في النواة بنجاح ستظهر الرسالة التالية\nأشجع القارئ على محاولة العثور على الثغرة في الكود السابق ومحاولة إستغلالها كتحدي ومن ثم إكمال القراءة للإطلاع على الحل.\nالثغرة نبدأ بتحليل عمل الـ Module\nفأول خطوة تحدث عند تنصيبه هي\n وفيها يتم تسجيله كـ Driver في النظام ووضع مؤشر لفنكشن ما في fun_ptr وثم طباعة رسالة.\nنرى أيضآ أن طريقة التواصل الوحيدة معه هي عن طريق device_write واللتي تستقبل معطى integer من المستخدم وعلى أساسه تقوم بتنفيذ أمر من أمرين وهما\n نلاحظ أن الأمر الأول 1 مسؤول عن تصفير متغير counter وأيضا المؤشر السابق اللذي تم وضعه في البداية في fun_ptr\nوالأمر الثاني 2 يقوم بإستدعاء الفنكشن الموجودة في المؤشر fun_ptr\nنرى أنه في الحالة الطبيعية يمكننا إرسال أمر 2 واللذي بدوره سيقوم بإستدعاء funt_ptr - incCounter \nوثم زيادة العدد في counter وطباعته. ولكن! ماذا لو قمنا بإستدعاء الأمر 1 قبل وثم استدعينا 2 ما اللذي سيحدث؟\nفي هذه الحالة سيكون المؤشر fun_ptr =  NULL\nوعند محاولة إستدعاءه سيحدث خطأ null pointer derefernce يؤدي لإغلاق النظام بما أنه في النواة. وهذا الخطأ هو ثغرتنا اللتي سنستغلها.\nعند البحث عن قيمة NULL في لغة الـ C سنرى أنها تساوي 0 مما يعني أن النواة تحاول إستدعاء فنكشن في العنوان 0\nبالعودة للصورة اللتي تشرح توزيع الذاكرة في العمليات نرى أن العناوين تبدأ من 0x0 … وتقع في الـ Userspace\nممايعني أنه يمكننا إستخدام الذاكرة في هذا العنوان ووضع فنكشن من كتابتنا لتقوم النواة بتنفيذه بصلاحياتها والقيام بتنفيذ مانريده.\nالإستغلال كل عملية في النظام يتم تخزين معلوماتها في struct في النواة يمكننا أن نرى ترتيبه من سورس linux sched.h\n يوجد مركب آخر بداخل المركب الأول بإسم cred ويحتوي على صلاحيات العملية cred.h linux\n اذا تمكنا من تغيير قيمة euid الى 0 فسيعتبر النظام العملية بصلاحيات root\nيمكننا أن نسلك طريق عمل كود مسؤول عن تغيير المركب بإستخدام prepare_creds وثم تحويله الى shellcode ووضعه في العنوان 0x0.\nمثال على الآلية السابقة بشكل مفصل\n Jack’s Blog\nالإستغلال النهائي  الحماية من الثغرة نظام Linux يحتوي على حماية مفعلة إفتراضيا mmap_min_addr مهمتها منع عمليات الـ Userspace من حجز ذاكرة في العنوان NULL أو 0\nأيضا من مهمة المبرمج التأكد من عدم تنفيد فنكشن بدون التأكد من أن العنوان صالح للإستخدام.\nالختام توجد مصادر كثيرة وتقنيات عديدة جدآ ومختلفة وثغرات مكتشفة سابقآ بشروح مفصلة يمكنك البحث عنها.\nبعض منها:\nhttp://www.jackson-t.ca/lg-driver-lpe.html\nhttps://0x00sec.org/t/kernel-exploitation-dereferencing-a-null-pointer/3850\nhttps://www.abatchy.com/2018/01/kernel-exploitation-1\nأرشيف مجموعة كبيرة : https://github.com/xairy/linux-kernel-exploitation\n","wordCount":"1236","inLanguage":"en","image":"https://wes4m.io/%3Cimage%20path/url%3E","datePublished":"2019-08-13T04:51:01-07:00","dateModified":"2019-08-13T04:51:01-07:00","author":{"@type":"Person","name":"wes4m"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wes4m.io/posts/kernel_exploitation/"},"publisher":{"@type":"Organization","name":"wes4m","logo":{"@type":"ImageObject","url":"https://wes4m.io/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://wes4m.io/ accesskey=h title="./ (Alt + H)">./</a>
<div class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</div>
</div>
<ul id=menu>
<li>
<a href=https://wes4m.io/tags/ title=Tags>
<span>Tags</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://wes4m.io/>Home</a>&nbsp;»&nbsp;<a href=https://wes4m.io/posts/>Posts</a></div>
<h1 class=post-title dir=rtl>
إستغلال ثغرات النواة | Kernel exploitation
</h1>
<div class=post-meta dir=rtl><span title="2019-08-13 04:51:01 -0700 -0700">August 13, 2019</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;wes4m&nbsp;|&nbsp;<a href=https://github.com/wes4m/wes4m.github.io/tree/drafting/content/posts/kernel_exploitation.md rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header>
<div class=post-content dir=rtl><p>من اكثر الامثلة شيوعآ للإستخدام في هذا الموضوع هي مصطلحات مثل Android rooting, IOS Jailbreak ، فالكثير منا على إطلاع بها وبالغرض منها. ولكن هل تسائلت من قبل كيف تعمل في عمقها ؟</p>
<p>أيضآ لماذا لايمكنك إنهاء عمليات الـ Anti virus من مدير المهام في نظام وندوز بكل بساطة ؟ أو كيف تخفي بعض ملفات الإختراق نفسها عن برامج تتبع الإتصالات ومدير المهام وغيره.</p>
<p>كل هذه الإمور والكثير من الأمثلة الإخرى يمكن تنفيذها بعدة طرق أحدها ومن أهمها هي إستخدام نواة النظام وإستغلالها.</p>
<h4 id=ماهي-النواة-kernel->ماهي النواة (Kernel) ؟<a hidden class=anchor aria-hidden=true href=#ماهي-النواة-kernel->#</a></h4>
<p>بشكل مبسط، تعمل أنظمة التشغيل مثل Windows, Linux, IOS وغيرها بنظام الطبقات والنواة هي أحد هذه الطبقات</p>
<p><img loading=lazy src=/images/os-kernel-layers.png alt=kernel-layers>
</p>
<p>فماتراه كمستخدم عادي هو الـ Userspace أو الطبقة الاولى اللتي تحتوي على البرامج وسطح المكتب وغيره من واجهات، تليها النواة واللتي بدورها تتواصل مع عتاد الجهاز من ذاكرة، لوحة مفاتيح، المعالج وغيره .. فهي جزء حساس جدآ وغير قابل للأخطاء البرمجية. على سبيل المثال في الـ Userspace عندما يحدث خطأ في برنامج ما قد يتوقف البرنامج عن العمل أو يتمكن من تفادي الخطأ عن طريق الـ Exception handlers</p>
<p>بينما الأخطاء في النواة قد تؤدي لعطب أجهزة وفي الغالب توقف النظام وإجبارك على إعادة تشغيله.</p>
<p>النواة مسؤولة عن التواصل مع العتاد والمدخلات والمخرجات للجهاز وإدارة نظام التشغيل بشكل مفصل جددآ فهي المسؤولة عن التواصل مع الذاكرة وحجز المساحات وعن تنظيم الصلاحيات وإدارة عمليات النظام وجدولتها، وأيضا حماية المستخدم وتوفير أمكانيات للعليات بالتواصل فيما بينها (IPC) وغيرها الكثير من مسؤوليات كبيرة تعق على النواة.</p>
<p>تعمل أغلب أنوية الأنظمة على شكل Drivers & Modules على عكس الـ Userspace اللذي يعمل على شكل تطبيقات في الغالب.</p>
<h4 id=أين-تقع-النواة->أين تقع النواة ؟<a hidden class=anchor aria-hidden=true href=#أين-تقع-النواة->#</a></h4>
<p>كما نعلم بأنه عند تشغيل أي برنامج يقوم النظام ( النواة ) بحجز مساحة في الذاكرة للبرنامج ومن ثم القيام بعلميات تجهيز الذاكرة وتحميل البرنامج فيها وجدولته وتشغيله. لكل برنامج مساحة في الذاكرة محددة قد تبدوا جميع موجوة في نفس العنوان من الذاكرة وذلك بسبب ( Virtual address space ) وهو موضوع واسع يمكنك القراءة فيه.</p>
<p>بشكل مبسط هو عنوان وهمي أو إفتراضي يعطى لكل عملية ولكنه مربوط بعنوان آخر على حسب العملية (Physical address) في الذاكرة.</p>
<p>فالنواة توجد في منطقة ثابته في الذاكرة ويتم إعطاء عنوان إفتراضي لها ايضا مع كل عملية.</p>
<p>ففي أنظمة الـ 64-bit سنرى أن لكل عملية عنواين إفتراضيه في الذاكرة من 0x000'00000000 - 0x7FF&rsquo;FFFFFFFF</p>
<p>بينما في 32-bit فالنطاق هو من 0x00000000 - 0x7FFFFFFF</p>
<p>ولكل عملية يتم تقسيم النطاق فيربط جزء منه للنواة لتصبح كل عملية قادرة على التواصل مع النواة.</p>
<p>صورة مثال لذاكرة عملية في النظام:</p>
<p><img loading=lazy src=/images/5PUMH.jpg alt="Image result for 64 bit process address space">
</p>
<h4 id=كيف-تتواصل-البرامج-مع-النواة->كيف تتواصل البرامج مع النواة ؟<a hidden class=anchor aria-hidden=true href=#كيف-تتواصل-البرامج-مع-النواة->#</a></h4>
<p>تتعمد طريقة التواصل على نظام التشغيل وآليته. لنأخد على سبيل المثال Linux</p>
<p>عندما يقوم مبرمج بعمل عملية وظيفتها طباعة نص للمستخدم فتسلسل الأحداث هو كالتالي</p>
<script src=https://gist.github.com/wes4m/40f472939d46860a490f281f73c18393.js></script>
<p>يمكننا عمل كومبايل وتتبع العملية عن طريق ltrace & strace أو تتبع سورس كود فنكشن printf وسنرى أن المسار التالي هو المتبع</p>
<script src=https://gist.github.com/wes4m/c70e12304721d2c3994a88159ca9aaa4.js></script>
<p>ومايهمنا هنا هو النقطة الأخيرة SYSCALL فهذه هي الوسيلة الأساسية في التواصل مع النواة. وظيفتها تغيير مود المعالج الى kernel mode ونقل التنفيد للنواة فالـ SYSCALL هي تعليمة محددة <code>INT 0x80</code> مع معلومات يتم وضعها في المسجلات والذاكرة</p>
<p>تقوم بعمل Exception فيقوم المعالج بدوره بالعثور على عنوان الـ Exception handler وهو ثابت تحت مسمى Vector 128 أو System call handler ويشير إلى فنكشن بإسم <code>system_call</code> موجود بالنواة يقوم بتوجيه المعطيات على حسب رقم موجود في أحد المسجلات ( Registers ) فيوجهه للفنكشن المناسبة في حالتنا هذه <code>sys_write</code> الموجودة في النواة واللتي ستقوم بالعملية المطلوبة والتواصل مع الشاشة لطباعة النص.</p>
<p><a href=http://books.gigatux.nl/mirror/kerneldevelopment/0672327201/ch05lev1sec3.html>للمزيد من المعلومات</a></p>
<h4 id=لماذا-لايمكننا-إستدعاء-عملية-sys_write-الموجودة-في-النواة-مباشرة-من-الـ-userspace->لماذا لايمكننا إستدعاء عملية sys_write الموجودة في النواة مباشرة من الـ Userspace ؟<a hidden class=anchor aria-hidden=true href=#لماذا-لايمكننا-إستدعاء-عملية-sys_write-الموجودة-في-النواة-مباشرة-من-الـ-userspace->#</a></h4>
<p>لانها ستعدم إنفصالية النواة عن الـ Userspace وستؤدي الى مشاكل امنية وعدم إستقرار في النظام فتواصل العمليات مباشرة مع النواة كما ناقشت سابقآ من السهل أن يؤدي لإغلاق النظام.</p>
<h2 id=ثغرات-النواة>ثغرات النواة<a hidden class=anchor aria-hidden=true href=#ثغرات-النواة>#</a></h2>
<p>بالرغم من طول المقدمة السابقة إلا أنها مختصرة ولاتعطي للنواة نصيبها من الشرح فهي أكبر واهم جزء في أنظمة التشغيل.</p>
<p>أما الآن فكيف يمكننا الوصول لذاكرة النواة، فالمعالج من وظيفته حماية ذاكرة النواة فلا يمكن للمبرمج بكل بساطة أن يحاول القراءة من عنوان ضمن نطاق ذاكرة النواة أو الكتابة إليه أو القفز لتنفيد كود فيه.</p>
<p>إلا أنه هناك بعض الهجمات اللتي تستهدف المعالج وبعض الالكترونيات في الجهاز مثل <a href=https://meltdownattack.com>Meltdown & Spectre</a></p>
<p>ولكنني سأتحدث حول ثغرات تنتج بسبب أخطاء برمجية سواء من مبرمجي Drivers & Modules النظام أو من شركات خارجية تقوم ببرمجة Drivers خاصة بهم للعمل مع النظام مثل كروت الشاشة وكروت الشبكة وغيرها من أجهزة أو برامج تحتاج لعمل Driver خاص.</p>
<p>فالثغرات التي تحدث بالنواة هي نفسها التي يمكنك العثور عليها في الـ Usersapce مثل ثغرات الـ Bufferover flow, use-after-free, race conditions وغيرها من ثغرات مع إختلاف طرق الإستغلال، أغلب ثغرات النواة تكون معقدة وعبارة عن سلسلة من الثغرات مربوطة ببعضها (exploit chain) للوصول للهدف.</p>
<p>كما طرحت في مقدمة الموضوع، على سبيل المثال أحد طرق عمل root لأجهزة Android هي ربط عدد من ثغرات النظام ببعضها بدئآ من الـ Userspace حتى الوصول للنواة (Kernel) ومن ثم التعديل على جدول الصلاحيات على سبيل المثال وإعطاء عملية محددة أعلى صلاحية في الجهاز root.</p>
<p>في هذا الموضوع سأتطرق لثغرة واحد فقط مع مثال لإستغلالها للحصول على رفع صلاحية (LPE - local privilege escalation)</p>
<h4 id=module-مبسط-لنواة-linux>Module مبسط لنواة Linux<a hidden class=anchor aria-hidden=true href=#module-مبسط-لنواة-linux>#</a></h4>
<p><a href=https://blog.sourcerer.io/writing-a-simple-linux-kernel-module-d9dc3762c234>شرح مفصل لطريقة برمجة Module للنواة</a></p>
<p>قمت ببرمجة Module بسيط يحتوي على ثغرة يمكن إستغلالها لرفع الصلاحيات.</p>
<p>بإستخدام الشرح السابق لتحميل مستلزمات الكومبايل. قم ببناء الـ Module التالي وتنصيبه في النواة</p>
<script src=https://gist.github.com/wes4m/ea787ef758a6d6bb790392385c3591d8.js></script>
<p>عند تنصيبه في النواة بنجاح ستظهر الرسالة التالية</p>
<p><img loading=lazy src=/images/initiated.png alt=initiated>
</p>
<p>أشجع القارئ على محاولة العثور على الثغرة في الكود السابق ومحاولة إستغلالها كتحدي ومن ثم إكمال القراءة للإطلاع على الحل.</p>
<h3 id=الثغرة>الثغرة<a hidden class=anchor aria-hidden=true href=#الثغرة>#</a></h3>
<p>نبدأ بتحليل عمل الـ Module</p>
<p>فأول خطوة تحدث عند تنصيبه هي</p>
<script src=https://gist.github.com/wes4m/5c99801b67bfffa22e3521b4b74abe42.js></script>
<p>وفيها يتم تسجيله كـ Driver في النظام ووضع مؤشر لفنكشن ما في <code>fun_ptr</code> وثم طباعة رسالة.</p>
<p>نرى أيضآ أن طريقة التواصل الوحيدة معه هي عن طريق <code>device_write</code> واللتي تستقبل معطى integer من المستخدم وعلى أساسه تقوم بتنفيذ أمر من أمرين وهما</p>
<script src=https://gist.github.com/wes4m/5cd0af7b38150ca2b637a1e204d55564.js></script>
<p>نلاحظ أن الأمر الأول <code>1</code> مسؤول عن تصفير متغير <code>counter</code> وأيضا المؤشر السابق اللذي تم وضعه في البداية في <code>fun_ptr</code></p>
<p>والأمر الثاني <code>2</code> يقوم بإستدعاء الفنكشن الموجودة في المؤشر <code>fun_ptr</code></p>
<p>نرى أنه في الحالة الطبيعية يمكننا إرسال أمر <code>2</code> واللذي بدوره سيقوم بإستدعاء <code>funt_ptr -> incCounter </code></p>
<p>وثم زيادة العدد في <code>counter</code> وطباعته. ولكن! ماذا لو قمنا بإستدعاء الأمر <code>1</code> قبل وثم استدعينا <code>2</code> ما اللذي سيحدث؟</p>
<p>في هذه الحالة سيكون المؤشر <code>fun_ptr</code> = <code> NULL</code></p>
<p>وعند محاولة إستدعاءه سيحدث خطأ <code>null pointer derefernce</code> يؤدي لإغلاق النظام بما أنه في النواة. وهذا الخطأ هو ثغرتنا اللتي سنستغلها.</p>
<p>عند البحث عن قيمة <code>NULL</code> في لغة الـ C سنرى أنها تساوي <code>0</code> مما يعني أن النواة تحاول إستدعاء فنكشن في العنوان 0</p>
<p>بالعودة للصورة اللتي تشرح توزيع الذاكرة في العمليات نرى أن العناوين تبدأ من 0x0 &mldr; وتقع في الـ Userspace</p>
<p>ممايعني أنه يمكننا إستخدام الذاكرة في هذا العنوان ووضع فنكشن من كتابتنا لتقوم النواة بتنفيذه بصلاحياتها والقيام بتنفيذ مانريده.</p>
<h3 id=الإستغلال>الإستغلال<a hidden class=anchor aria-hidden=true href=#الإستغلال>#</a></h3>
<p>كل عملية في النظام يتم تخزين معلوماتها في <code>struct</code> في النواة يمكننا أن نرى ترتيبه من سورس linux <code>sched.h</code></p>
<script src=https://gist.github.com/wes4m/d20471e361a8c9aaa5b46c67a388fc83.js></script>
<p>يوجد مركب آخر بداخل المركب الأول بإسم <code>cred</code> ويحتوي على صلاحيات العملية
<code>cred.h</code> linux</p>
<script src=https://gist.github.com/wes4m/cae04223559a01a614f52c1612aa0802.js></script>
<p>اذا تمكنا من تغيير قيمة <code>euid</code> الى <code>0</code> فسيعتبر النظام العملية بصلاحيات <code>root</code></p>
<p>يمكننا أن نسلك طريق عمل كود مسؤول عن تغيير المركب بإستخدام <code>prepare_creds</code> وثم تحويله الى <code>shellcode</code> ووضعه في العنوان <code>0x0</code>.</p>
<p>مثال على الآلية السابقة بشكل مفصل</p>
<script src=https://gist.github.com/wes4m/3b1fbcb6ec37b7bf3280753126722292.js></script>
<p><a href=https://blog.cubieserver.de/2018/modify-process-credentials-in-linux-kernel/>Jack&rsquo;s Blog</a></p>
<h3 id=الإستغلال-النهائي>الإستغلال النهائي<a hidden class=anchor aria-hidden=true href=#الإستغلال-النهائي>#</a></h3>
<script src=https://gist.github.com/wes4m/3c896e206a79a5ac4970f66439c1fd60.js></script>
<h2 id=الحماية-من-الثغرة>الحماية من الثغرة<a hidden class=anchor aria-hidden=true href=#الحماية-من-الثغرة>#</a></h2>
<p>نظام Linux يحتوي على حماية مفعلة إفتراضيا <code>mmap_min_addr</code> مهمتها منع عمليات الـ Userspace من حجز ذاكرة في العنوان NULL أو 0</p>
<p>أيضا من مهمة المبرمج التأكد من عدم تنفيد فنكشن بدون التأكد من أن العنوان صالح للإستخدام.</p>
<h3 id=الختام>الختام<a hidden class=anchor aria-hidden=true href=#الختام>#</a></h3>
<p>توجد مصادر كثيرة وتقنيات عديدة جدآ ومختلفة وثغرات مكتشفة سابقآ بشروح مفصلة يمكنك البحث عنها.</p>
<p>بعض منها:</p>
<p><a href=http://www.jackson-t.ca/lg-driver-lpe.html>http://www.jackson-t.ca/lg-driver-lpe.html</a></p>
<p><a href=https://0x00sec.org/t/kernel-exploitation-dereferencing-a-null-pointer/3850>https://0x00sec.org/t/kernel-exploitation-dereferencing-a-null-pointer/3850</a></p>
<p><a href=https://www.abatchy.com/2018/01/kernel-exploitation-1>https://www.abatchy.com/2018/01/kernel-exploitation-1</a></p>
<p>أرشيف مجموعة كبيرة : <a href=https://github.com/xairy/linux-kernel-exploitation>https://github.com/xairy/linux-kernel-exploitation</a></p>
</div>
<footer class=post-footer>
<ul class=post-tags dir=rtl>
<li><a href=https://wes4m.io/tags/kernel/>Kernel</a></li>
<li><a href=https://wes4m.io/tags/linux/>Linux</a></li>
<li><a href=https://wes4m.io/tags/pwn/>PWN</a></li>
<li><a href=https://wes4m.io/tags/misc/>Misc</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://wes4m.io/posts/browser_exploitation/>
<span class=title>« Prev</span>
<br>
<span>إستغلال ثغرات المتصفح | Webbrowser exploitation</span>
</a>
<a class=next href=https://wes4m.io/posts/dragonsector_production/>
<span class=title>Next »</span>
<br>
<span>حل تحدي Production - DragonCTF</span>
</a>
</nav>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2025 <a href=https://wes4m.io/>wes4m</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>